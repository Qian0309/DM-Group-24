---
title: "datachecks"
author: "Deepak"
date: "2024-03-18"
output: html_document
---

# Data Quality checks

## Id format checks for all primary and foregin keys
```{r checkprimary,message=FALSE,warning=FALSE,attr.source='.numberLines'}


dataname_list <- list("address_data", "buyer_data", "dimension_data", "order_details_data", "payment_data",
                 "product_data", "promotion_data", "review_data", "shipper_data", "supplier_data")

idname_list <- list("address_id", "buyer_id", "dimension_id","order_id","payment_id","product_id",
                    "promotion_id", "review_id", "shipper_id", "supplier_id")

idformat_list <-  list("AD","BU","DM","OR","PD","PR",
                       "PM","RV","SH","SP")

# Loop through each data file
for (i in seq_along(dataname_list)) {
  # Load data file
  datatemp <- get(dataname_list[[i]])
  
  for (j in seq_along(idname_list)){
     # Get the ID column name and format for the current data file
  id_col <- idname_list[[j]]
  id_format <- idformat_list[[j]]
  
  # Check if the ID column exists in the data frame
  if (id_col %in% colnames(datatemp)) {
    # Filter rows where the ID column does not match the specified format
    id_data <- datatemp %>%
      filter(!grepl(paste0("^", id_format), get(id_col)))
    
  } else {
    print(paste0("ID column ", id_col, " not found in ", dataname_list[[i]], "\n"))
  } 
  
  # Print the filtered data
    print(paste0("Checking for format for ", id_col, " in the dataframe ", dataname_list[[i]]))
    
    if (nrow(id_data)!=0){
    print(paste0(nrow(id_data), " rows are removed from ",dataname_list[[i]], " because of incorrect id format" ))
    print(paste0("THe removed data are ", id_data))
    assign(dataname_list[[i]], anti_join(datatemp, id_data, by = id_col))
    }   
    id_data <-  id_data[0, ]
    
  }
    
}

```

## Data checks for the address 

```{r checkprimary,message=FALSE,warning=FALSE,attr.source='.numberLines'}

# Getting the negative house number data
negative_data <- address_data %>% 
  filter(house_number < 0)

# Print the filtered data
print(paste0("Checking for incorrect data in the address "))
    
if (nrow(negative_data)!=0){
print(paste0(nrow(negative_data), " rows are removed from address because of incorrect data" ))
  print(paste0("The removed data are ", negative_data))
}

# Removing it from the address data
address_data <- anti_join(address_data, negative_data, by = "address_id")

# Removing the same from the other tables having address as a foreign key
buyer_data <- anti_join(buyer_data, negative_data, by = "address_id")
supplier_data <- anti_join(supplier_data, negative_data, by = "address_id")
  
```

## Data checks for the buyer 

```{r checkprimary,message=FALSE,warning=FALSE,attr.source='.numberLines'}

# Convert character dates to Date data type
buyer_data$date_of_birth <- anydate(buyer_data$date_of_birth)

# Filter for dates later than the current date
current_date <- Sys.Date()
negative_data <- buyer_data[buyer_data$date_of_birth > current_date, ]

# Print the filtered data
print(paste0("Checking for incorrect data in the buyer "))
    
if (nrow(negative_data)!=0){
print(paste0(nrow(negative_data), " rows are removed from buyer because of incorrect data" ))
  print(paste0("The removed data are ", negative_data))
}

# Removing it from the buyer data
buyer_data <- anti_join(buyer_data, negative_data, by = "buyer_id")

# Removing the same from the other tables having address as a foreign key
order_details_data <- anti_join(order_details_data, negative_data, by = "buyer_id")
review_data <- anti_join(review_data, negative_data, by = "buyer_id")


```

## Data checks for the dimension 

```{r checkprimary,message=FALSE,warning=FALSE,attr.source='.numberLines'}

# Getting the negative and over the upper limit dimensions data
negative_data <- dimension_data %>% 
  filter(length < 0 | length > 150 |
           width < 0 | width > 150 |
           height < 0 | height > 150)



# Print the filtered data
print(paste0("Checking for incorrect data in the dimension"))
    
if (nrow(negative_data)!=0){
print(paste0(nrow(negative_data), " rows are removed from dimension because of incorrect data" ))
  print(paste0("The removed data are ", negative_data))
}

# Removing it from all tables containing dimension id
dimension_data <- anti_join(dimension_data, negative_data, by = "dimension_id")
product_data <- anti_join(product_data, negative_data, by = "dimension_id")

```

## Data checks for the order details 

```{r checkprimary,message=FALSE,warning=FALSE,attr.source='.numberLines'}

# Convert character dates to Date data type
order_details_data$order_dates <- anydate(order_details_data$order_dates)

# Filter for dates later than the current date
current_date <- Sys.Date()
negative_data <- order_details_data[order_details_data$order_dates > current_date, ]

# Print the filtered data
print(paste0("Checking for incorrect data in the order details "))
    
if (nrow(negative_data)!=0){
print(paste0(nrow(negative_data), " rows are removed from order because of incorrect data" ))
  print(paste0("The removed data are ", negative_data))
}

# Removing it from the order data
order_details_data <- anti_join(order_details_data, negative_data, by = "order_id")

# Removing the same from the other tables having address as a foreign key
payment_data <- anti_join(payment_data, negative_data, by = "order_id")


```

## Data checks for the payment data 

```{r checkprimary,message=FALSE,warning=FALSE,attr.source='.numberLines'}

# Getting the negative payment data
negative_data <- payment_data %>% 
  filter(payment_amount < 0 | installment_number < 0 )

# Print the filtered data
print(paste0("Checking for incorrect data in the payment details"))
    
if (nrow(negative_data)!=0){
print(paste0(nrow(negative_data), " rows are removed from payment data because of incorrect data" ))
  print(paste0("The removed data are ", negative_data))
}

# Removing it from all tables containing payment id
payment_data <- anti_join(payment_data, negative_data, by = "payment_id")


```

## Data checks for the product data 

```{r checkprimary,message=FALSE,warning=FALSE,attr.source='.numberLines'}

# Getting the negative and out of limits product data
negative_data <- product_data %>% 
  filter(price < 0 | weight < 0 | weight > 100)

# Print the filtered data
print(paste0("Checking for incorrect data in the product data"))
    
if (nrow(negative_data)!=0){
print(paste0(nrow(negative_data), " rows are removed from product data because of incorrect data" ))
  print(paste0("The removed data are ", negative_data))
}

# Removing it from all tables containing product id
product_data <- anti_join(product_data, negative_data, by = "product_id")

```

## Data checks for the promotion data 

```{r checkprimary,message=FALSE,warning=FALSE,attr.source='.numberLines'}

# Convert character dates to Date data type
promotion_data$start_date <- anydate(promotion_data$start_date)
promotion_data$end_date <- anydate(promotion_data$end_date)

# Filter for end dates before start dates
negative_data <- promotion_data[promotion_data$start_date > promotion_data$end_date, ]

# Print the filtered data
print(paste0("Checking for incorrect data in the promotion details "))
    
if (nrow(negative_data)!=0){
print(paste0(nrow(negative_data), " rows are removed from promotion because of incorrect data" ))
  print(paste0("The removed data are ", negative_data))
}

# Removing it from all tables containing product id
promotion_data <- anti_join(promotion_data, negative_data, by = "promotion_id")
product_data <- anti_join(product_data, negative_data, by = "promotion_id")

```

## Data checks for the review data 

```{r checkprimary,message=FALSE,warning=FALSE,attr.source='.numberLines'}

# Getting the negative and out of limits review data
negative_data <- review_data %>% 
  filter(review_score < 0 | review_score >10 )

# Print the filtered data
print(paste0("Checking for incorrect data in the review data"))
    
if (nrow(negative_data)!=0){
print(paste0(nrow(negative_data), " rows are removed from review data because of incorrect data" ))
  print(paste0("The removed data are ", negative_data))
}

# Removing it from all tables containing review id
review_data <- anti_join(review_data, negative_data, by = "review_id")

```

## Data checks for the shipper data 

```{r checkprimary,message=FALSE,warning=FALSE,attr.source='.numberLines'}

# Getting the negative and out of limits shipper data
negative_data <- shipper_data %>% 
  filter(fixed_price < 0 | cost_per_mile < 0 )

# Print the filtered data
print(paste0("Checking for incorrect data in the shipper data"))
    
if (nrow(negative_data)!=0){
print(paste0(nrow(negative_data), " rows are removed from shipper data because of incorrect data" ))
  print(paste0("The removed data are ", negative_data))
}

# Removing it from all tables containing shipper id
shipper_data <- anti_join(shipper_data, negative_data, by = "shipper_id")


```

## Data checks for the supplier data 

```{r checkprimary,message=FALSE,warning=FALSE,attr.source='.numberLines'}

# Getting the negative and out of limits supplier data
negative_data <- supplier_data %>% 
  filter(number_of_year_of_association < 0 )

# Print the filtered data
print(paste0("Checking for incorrect data in the supplier data"))
    
if (nrow(negative_data)!=0){
print(paste0(nrow(negative_data), " rows are removed from supplier data because of incorrect data" ))
  print(paste0("The removed data are ", negative_data))
}

# Removing it from all tables containing shipper id
supplier_data <- anti_join(supplier_data, negative_data, by = "supplier_id")

```
