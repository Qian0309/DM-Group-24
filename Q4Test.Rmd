---
title: "Q4Test"
output: html_document
date: "2024-03-15"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
install.packages(c("DBI", "RSQLite", "dplyr","ggplot2"))

library(DBI)
library(RSQLite)
library(dplyr)
library(ggplot2)
```

```{r}
db_conn <- dbConnect(RSQLite::SQLite(), "database/ecommerce.db")
```


1) Products With Highest Sales
```{r}
top_5_products_sales <- dbGetQuery(db_conn, "SELECT
    od.product_id,
    p.product_name,
    SUM(p.price) AS total_sales
FROM
    order_details od
JOIN
    product p ON od.product_id = p.product_id
GROUP BY
    od.product_id,
    p.product_name
ORDER BY
    total_sales DESC
LIMIT
    5;
")

# Viewing the results
print(top_5_products_sales)

```

```{r}
ggplot(top_5_products_sales, aes(x = reorder(product_name, total_sales), y = total_sales, fill = product_name)) +
  geom_col() + 
  labs(title = "Top 5 Products by Sales", x = "Product Name", y = "Total Sales") +
  theme_minimal() +
  scale_fill_viridis_d() +
  coord_flip() + 
  scale_fill_discrete(name = "Product Name") + 
  theme(legend.position = "none") 
```
2) Can't Read Handwriting

3) Number of days promotions are running (Not Working)

```{r}
no_of_days_promotions <- dbGetQuery(db_conn, "SELECT
    promotion_id,
    promotion_type,
    start_date,
    end_date,
    julianday(end_date) - julianday(start_date) AS promotion_duration_days
FROM
    promotion
ORDER BY
    promotion_duration_days DESC
LIMIT
    5;;
")

print(no_of_days_promotions)

```

4) Sales Trends
```{r}
monthly_sales_trends <- dbGetQuery(db_conn,"SELECT
    strftime('%Y-%m', order_dates) AS month,
    COUNT(*) AS number_of_orders,
    SUM(p.price) AS total_sales
FROM
    order_details od
JOIN
    product p ON od.product_id = p.product_id
GROUP BY
    month
ORDER BY
    month ASC;
")

# Viewing the results
print(monthly_sales_trends)

```



5) Products With Highest Review

```{r}
top_5_products_reviews <- dbGetQuery(db_conn, "SELECT
    r.product_id,
    p.product_name,
    AVG(r.review_score) AS avg_review_score
FROM
    review r
JOIN
    product p ON r.product_id = p.product_id
GROUP BY
    r.product_id,
    p.product_name
ORDER BY
    avg_review_score DESC
LIMIT
    5;
")

# Viewing the results
print(top_5_products_reviews)
```

```{r}
ggplot(top_5_products_reviews, aes(x = reorder(product_name, avg_review_score), y = avg_review_score, fill = product_name)) +
  geom_col(show.legend = FALSE) + 
  coord_flip() + 
  labs(title = "Top 5 Products by Average Review Score", x = "Product Name", y = "Average Review Score") +
  theme_minimal() +
  scale_fill_viridis_d() + 
  theme(plot.title = element_text(hjust = 0.5)) 

```


6) Products With Lowest Review

```{r}
lowest_5_products_reviews <- dbGetQuery(db_conn, "SELECT
    p.product_id,
    p.product_name,
    AVG(r.review_score) AS average_review_score
FROM
    review r
JOIN
    product p ON r.product_id = p.product_id
GROUP BY
    p.product_id,
    p.product_name
ORDER BY
    average_review_score ASC
LIMIT
    5;
")

# Viewing the results
print(lowest_5_products_reviews)
```



7) Cities With Lowest Review

```{r}

lowest_5_city_reviews <- dbGetQuery(db_conn, "SELECT
    a.city,
    AVG(r.review_score) AS average_review_score
FROM
    review r
JOIN
    buyer b ON r.buyer_id = b.buyer_id
JOIN
    address a ON b.address_id = a.address_id
GROUP BY
    a.city
ORDER BY
    average_review_score ASC
LIMIT
    5;
")

# Viewing the results
print(lowest_5_city_reviews)

```


8) Cities With Highest Review

```{r}

highest_5_city_reviews <- dbGetQuery(db_conn, "SELECT
    a.city,
    AVG(r.review_score) AS average_review_score
FROM
    review r
JOIN
    buyer b ON r.buyer_id = b.buyer_id
JOIN
    address a ON b.address_id = a.address_id
GROUP BY
    a.city
ORDER BY
    average_review_score DESC
LIMIT
    5;
")

# Viewing the results
print(highest_5_city_reviews)

```


9) Estimate the CLV based on historical transactions to identify your most valuable customers.

```{r}
customer_lifetime_value <- dbGetQuery(db_conn, "SELECT
    buyer_id,
    SUM(p.price) AS total_spent,
    COUNT(distinct order_id) AS number_of_orders,
    (SUM(p.price) / COUNT(distinct order_id)) AS average_order_value
FROM
    order_details od
JOIN
    product p ON od.product_id = p.product_id
GROUP BY
    buyer_id
ORDER BY
    total_spent DESC;
")

# Viewing the results
print(customer_lifetime_value)

```



10) Effective of Promotions

```{r}
effective_promotions <- dbGetQuery(db_conn, "SELECT
    promo.promotion_type,
    COUNT(*) AS number_of_sales,
    SUM(prod.price) AS total_revenue
FROM
    order_details od
JOIN
    product prod ON od.product_id = prod.product_id
JOIN
    promotion promo ON prod.promotion_id = promo.promotion_id
WHERE
    promo.status = 'active'
GROUP BY
    promo.promotion_type
ORDER BY
    total_revenue DESC;;
")

# Viewing the results
print(effective_promotions)

```


10) Most Reviewed Products

```{r}
most_reviewed_products <- dbGetQuery(db_conn,"SELECT
    p.product_name,
    COUNT(*) AS review_count,
    AVG(r.review_score) AS avg_review_score
FROM
    review r
JOIN
    product p ON r.product_id = p.product_id
GROUP BY
    p.product_name
ORDER BY
    review_count DESC
LIMIT 10;
")

# Viewing the results
print(most_reviewed_products)

```

11) Cities With Highest Sales.
```{r}

cities_highest_sales <- dbGetQuery(db_conn,"SELECT
    a.city,
    SUM(p.price) AS total_sales
FROM
    order_details od
JOIN
    product p ON od.product_id = p.product_id
JOIN
    buyer b ON od.buyer_id = b.buyer_id
JOIN
    address a ON b.address_id = a.address_id
GROUP BY
    a.city
ORDER BY
    total_sales DESC
LIMIT
    5;
")

# Viewing the results
print(cities_highest_sales)

```

```{r}
ggplot(cities_highest_sales, aes(x = city, y = total_sales)) +
  geom_bar(stat = "identity", fill = "skyblue", width = 0.5) +
  labs(title = "City with Highest Sales", x = "City", y = "Total Sales") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```






dbDisconnect(db_conn)
```







